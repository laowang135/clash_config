name: Update Clash Config

on:
  schedule:
    - cron: '0 22 * * *'  # 每天早上 6 点（北京时间）自动运行
  workflow_dispatch:  # 允许手动触发

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v3

      - name: 获取最新 Clash 配置
        run: |
          TODAY=$(date +"%Y%m%d")
          LATEST_URL="https://free.datiya.com/uploads/${TODAY}-clash.yaml"
          SAVE_PATH="uploads/clash.yaml"

          echo "正在下载最新的 Clash 配置: $LATEST_URL"
          curl -o "$SAVE_PATH" -L "$LATEST_URL"
          echo "✅ 下载成功: $SAVE_PATH"

      - name: 修改 Clash 配置
        run: |
          sed -i 's/interval: 300/interval: 30/' uploads/clash.yaml
          echo "✅ 配置已修改，DNS 增加 & interval 设置为 30 秒"

      - name: 提交更新
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

          git add uploads/clash.yaml
          git commit -m "更新 Clash 配置文件: $(date +'%Y-%m-%d')" || echo "⚠️ 没有内容变化，跳过提交"
          git push
